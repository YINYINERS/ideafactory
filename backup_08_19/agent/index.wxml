<view class="page-container" bindtap="onPageTap">
  <!-- 背景图片 -->
  <image class="background-image" src="/images/agent-bg.jpg" mode="aspectFill"></image>
  <!-- 毛玻璃遮罩层 -->
  <view class="glass-overlay"></view>
  
  <!-- 状态栏 - 重新放到外面，固定定位 -->
  <view class="status-bar" catchtap="onInputAreaTap">
    <!-- AI在线状态 -->
    <view class="status-indicator">
      <view class="status-dot {{isOnline ? 'online' : 'offline'}}"></view>
      <text class="status-text">{{isOnline ? 'AgentOnline' : 'AgentOffline'}}</text>
    </view>
    
    <!-- 新建对话按钮 -->
    <view class="new-chat-btn" bindtap="onNewChat" bindlongpress="onConfigIcon">
      <image class="new-chat-icon" src="{{statusIcon}}" mode="aspectFit"></image>
    </view>
  </view>
  
  <!-- 整个滚动区域 - 添加动态高度调整 -->
  <scroll-view
    class="chat-container"
    style="height: calc(100vh - 140rpx - {{keyboardHeight}}px);"
    scroll-y="true"
    scroll-with-animation="true"
    scroll-top="{{scrollTop}}"
    bindscrolltolower="onScrollToLower"
    bindscroll="onScroll"
  >
    <!-- 顶部占位，避免内容被状态栏遮挡 -->
    <view class="status-placeholder"></view>
    
    <!-- 欢迎标题 -->
    <view class="welcome-area" wx:if="{{messages.length === 0}}">
      <view class="welcome-title">Hello! My young Fella!</view>
    </view>
    
    <!-- 聊天消息 -->
    <view class="messages-list">
      <block wx:for="{{messages}}" wx:key="id">
        <!-- AI消息 -->
        <view wx:if="{{item.type === 'ai'}}" class="message-row ai-row">
          <image class="ai-avatar-image" src="/images/ai-icon.png" mode="aspectFit"></image>
          <view class="ai-message-container">
            <view class="message-bubble ai-bubble {{item.isError ? 'error-bubble' : ''}}">
              <text class="bubble-text">{{item.content}}</text>
              <text class="message-time">{{formatTime(item.timestamp)}}</text>
            </view>
            <!-- AI消息操作按钮 -->
            <view class="ai-message-actions">
              <button
                class="ai-action-btn"
                bindtap="onCopy"
                data-content="{{item.content}}"
              >
                <image class="action-icon-img" src="/images/copy-icon.png" mode="aspectFit"></image>
              </button>
              <button
                class="ai-action-btn"
                bindtap="onRegenerate"
                data-message-id="{{item.id}}"
              >
                <image class="action-icon-img" src="/images/refresh-icon.png" mode="aspectFit"></image>
              </button>
            </view>
          </view>
        </view>
        
        <!-- 用户消息 -->
        <view wx:else class="message-row user-row">
          <view class="message-bubble user-bubble">
            <text class="bubble-text">{{item.content}}</text>
            <text class="message-time">{{formatTime(item.timestamp)}}</text>
          </view>
        </view>
      </block>
      
      <!-- 正在输入 -->
      <view wx:if="{{isTyping}}" class="message-row ai-row">
        <image class="ai-avatar-image" src="/images/ai-icon.png" mode="aspectFit"></image>
        <view class="typing-bubble">
          <view class="typing-animation">
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
          </view>
          <text class="typing-text">思考中</text>
        </view>
      </view>
    </view>
    
    <!-- 底部占位 - 增加高度确保按钮可见 -->
    <view class="bottom-padding" style="height: {{isKeyboardShow ? '200rpx' : '120rpx'}};"></view>
  </scroll-view>
  
  <!-- 底部输入栏 - 添加动态位置调整和阻止冒泡 -->
  <view class="input-bar" style="bottom: {{keyboardHeight}}px;" catchtap="onInputAreaTap">
    <view class="input-wrapper">
      <input
        class="text-input"
        placeholder="输入你的问题"
        value="{{inputText}}"
        bindinput="onInputChange"
        bindkeyboardheightchange="onKeyboardHeightChange"
        bindconfirm="sendMessage"
        bindfocus="onInputFocus"
        bindblur="onInputBlur"
        maxlength="1000"
        type="text"
        confirm-type="send"
        adjust-position="{{false}}"
        hold-keyboard="{{true}}"
      />
      
      <!-- 发送按钮 -->
      <view
        class="send-btn"
        bindtap="sendMessage"
      >
        <image
          class="send-icon-img"
          src="/images/send-icon.png"
          mode="aspectFit"
          style="filter: {{inputText.length > 0 ? 'brightness(1) saturate(1)' : 'grayscale(1) brightness(0.6)'}}; opacity: {{inputText.length > 0 ? '1' : '0.5'}};"
        ></image>
      </view>
    </view>
  </view>
</view>